<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>metal-trade-network</title>

    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/x-icon" href="/api-doc/composer/unstable/favicon.ico">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">


    <link href="./assets/css/normalize.css" rel="stylesheet">
    <link href="./assets/css/new-style.min.css" rel="stylesheet">
    <link href="./assets/css/grid-layout.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.6.0/clipboard.min.js"></script>

</head>


<body class="">

    <div class="SiteWrapper">
        <div class="content">
            <article class="docs-container">

                 <div class="page-sidebar-grid" id="off-canvas">
                
                    <div class="docs-pagenav-grid">
                        <!-- Navigation -->
                        <nav class="navbar-docs" role="navigation">
                            <div class="search-form">
                            <img width="200px" src="https://hyperledger.github.io/composer-sample-networks/packages/bond-network/networkimage.svg"></img>
                            </div>

                            <!-- Brand and toggle get grouped for better mobile display -->
                            <a class="navbar-brand" href="./index.html">
                                <b>metal-trade-network</b></a>0.0.1
                            <!-- Collect the nav links, forms, and other content for toggling -->
                            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                                <div class="top-nav-docs">
                                    <a href="./index.html">Summary</a>
                                    <a href="./assets.html">Assets</a>
                                    <a href="./transactions.html">Transactions</a>
                                    <a href="./participants.html">Participants</a>                                    
                                    <a href="./queries.html">Queries</a>    
                                    <a href="./acls.html">ACLs</a>    
                                </div>
                            </div>
                        </nav>
                            <div class="docs-current-page-grid">
                                <p>Transactions</p>
                            </div>
                    </div>
                    
                  <nav class="context-nav">
                    <ul>
                       
                            
                                <li><p><a href="#lib/logic.js"><b>lib/logic.js</b></a></p>
                                <ul>
                                 
                                    <li><p><a href="#submitlisting"><b>submitListing</b></a></p></li>             
                                
                                    <li><p><a href="#tradecommodity"><b>tradeCommodity</b></a></p></li>             
                                
                                </ul></li>
                            
                    

                    </ul>

                    </nav>
  
                </div>



                <div class="page-content-grid">
                    <section class="content-chunk" id="readme">
                    <h1 id="transaction-functions-detail">Transaction Functions Detail</h1>
<p><em>Identifier</em> lib/logic.js
<em>Functions</em></p>
<h4 id="submitlisting">submitListing</h4>
<pre><code class="language-javascript">function submitListing(listingtx){

    var exchangeToListOn = listingtx.exchange;
    var trader = getCurrentParticipant();

    var newListing = getFactory().newResource('ampretia.mtn','CommodityListing',listingtx.newid);

    newListing.commodity = listingtx.commodity;
    newListing.quantity = listingtx.quantity;
    newListing.offerPrice = listingtx.offerPrice;
    newListing.offeringHouse = trader.employer;

    exchangeToListOn.listedCommodities.push(newListing);

    var exchangeRegistry;
    var listingRegsitry;

    return getAssetRegistry('ampretia.mtn.CommodityListing')
      .then(function (result){
          listingRegsitry = result;
          return getAssetRegistry('ampretia.mtn.Exchange');
      })
      .then(function(result){
          exchangeRegistry = result;
      })
      .then(function(){
          return listingRegsitry.add(newListing);
      })
      .then(function(){
          return exchangeRegistry.update(exchangeToListOn);
      });

}
</code></pre>
<p><img src="submitListing.svg" alt="submitListing"></p>
<h4 id="tradecommodity">tradeCommodity</h4>
<pre><code class="language-javascript">function tradeCommodity(trade) {

    // get details of the trade
    var symbol = trade.line.tradingSymbol;
    var cost = trade.line.quantity;

    var exchange = trade.exchange;
    // get details of the trader
    var trader = trade.trader;

    var newHolding;
    var listing;
    var exchange = trade.exchange;
    var brokage = trade.trader.employer;

    var regisitries = {};

    return getAssetRegistry('ampretia.mtn.CommodityHolding')
    .then(function (result){
        regisitries['ampretia.mtn.CommodityHolding']=result;
        return getAssetRegistry('ampretia.mtn.CommodityListing');
    })
    .then(function (result){
        regisitries['ampretia.mtn.CommodityListing']=result;
        return getAssetRegistry('ampretia.mtn.Exchange');
    })
    .then(function (result){
        regisitries['ampretia.mtn.Exchange']=result;
        return getAssetRegistry('ampretia.mtn.Brokage');
    })
    .then(function (result){
        regisitries['ampretia.mtn.Brokage']=result;
        return getParticipantRegistry('ampretia.mtn.Trader');
    })
    .then(function (result){
        regisitries['ampretia.mtn.Trader']=result;
        // need to see if the exchange has the commodity listed,
        var possibleListings = exchange.listedCommodities.filter(function(e) {
            // look for listings that match the requested symbol
            return (e.commodity.tradingSymbol === symbol) &amp;&amp;
               (e.quantity &gt;= trade.line.quantity);
        });

        if (!possibleListings){
            throw new Error('Commodity is not currently listed for trade');
        }

            // find a suitable listing... asserting that the purchase has to come from
        // only one listing  and is the price acceptable
        // TODO

        listing = possibleListings[0];
        newHolding = getFactory().newResource('ampretia.mtn','CommodityHolding',trade.mytradeid);

        newHolding.commodity = listing.commodity;
        newHolding.quantity = trade.line.quantity;
        newHolding.purchasePrice = listing.offerPrice;
        newHolding.tradedBy = trader;

        listing.quantity -= trade.line.quantity;

        if ((listing.offerPrice * trade.line.quantity) &gt; trader.fundLimit){
            // TODO emit event
            throw new Error('You can not afford that');
        }
        trader.fundLimit -= (listing.offerPrice * trade.line.quantity);
        // TODO if zero need to remove listing.

        brokage.portfolio.push(newHolding);
    }).then(function(){
        // put the assets back
        return regisitries['ampretia.mtn.CommodityHolding'].add(newHolding);
    })
    .then(function(){
        // put the assets back
        return regisitries['ampretia.mtn.CommodityListing'].update(listing);
    }).then(function(){
        return regisitries['ampretia.mtn.Brokage'].update(brokage);
    }).then(function(){
        return regisitries['ampretia.mtn.Exchange'].update(exchange);
    }).then(function(){
        return regisitries['ampretia.mtn.Trader'].update(trader);
    }).then(function(){
       // var url = &quot;https://hooks.slack.com/services/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&quot;;
       // return post(url, listing);
    });

}
</code></pre>
<p><img src="tradeCommodity.svg" alt="tradeCommodity"></p>
 
                    </section>
                </div>
                <!-- Otherwise, have the main content fill all 12 columns... -->

                <div class="PageNavigation">


                </div>
            </article>
        </div>





    </div>
    <script src="./assets/js/nav.js"></script>
</body>

</html>





